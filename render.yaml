services:
  - type: web
    name: gutenberg-characters
    env: node
    plan: free
    region: oregon
    
    buildCommand: |
      # Set environment variables
      export NODE_ENV=production
      export NODE_OPTIONS="--max-old-space-size=4096"
      export NPM_CONFIG_REGISTRY=https://registry.npmjs.org/
      
      # Clear any existing caches and old builds
      rm -rf client/dist server/dist
      
      # Install dependencies with npm
      npm install
      
      # Build both client and server
      npm run build
      
      # Verify builds
      if [ ! -d "client/dist" ]; then
        echo "‚ùå Client build failed - dist directory not found"
        exit 1
      fi
      
      if [ ! -d "server/dist" ]; then
        echo "‚ùå Server build failed - dist directory not found"
        exit 1
      fi
      
      echo "‚úÖ Build verification passed"
      echo "üìÅ Client build: $(ls -la client/dist | wc -l) files"
      echo "üìÅ Server build: $(ls -la server/dist | wc -l) files"
    
    startCommand: |
      cd server && npm start
    
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: NPM_CONFIG_REGISTRY
        value: https://registry.npmjs.org/
      - key: NODE_OPTIONS
        value: --max-old-space-size=4096
