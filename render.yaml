services:
  - type: web
    name: gutenberg-characters
    env: node
    plan: free
    region: oregon
    
    buildCommand: |
      # Set environment variables
      export NODE_ENV=production
      export NODE_OPTIONS="--max-old-space-size=4096"
      export NPM_CONFIG_REGISTRY=https://registry.npmjs.org/
      
      echo "🚀 Starting build process..."
      
      # Install dependencies
      echo "📦 Installing dependencies..."
      npm install
      
      # Build client with Vite (skip TypeScript compilation)
      echo "🔨 Building client with Vite..."
      cd client
      npm install
      npx vite build --mode production
      if [ $? -ne 0 ]; then
        echo "❌ Client build failed"
        exit 1
      fi
      cd ..
      
      # Verify client build
      if [ ! -d "client/dist" ]; then
        echo "❌ Client build failed - dist directory not found"
        exit 1
      fi
      if [ ! -f "client/dist/index.html" ]; then
        echo "❌ Client build failed - index.html not found"
        exit 1
      fi
      echo "✅ Client build successful"
      echo "📁 Client dist contents:"
      ls -la client/dist/
      
      # Build server
      echo "🔨 Building server..."
      cd server
      npm install
      npx tsc
      if [ $? -ne 0 ]; then
        echo "❌ Server build failed"
        exit 1
      fi
      
      # Verify server build
      if [ ! -f "dist/index.js" ]; then
        echo "❌ Server build failed - dist/index.js not found"
        exit 1
      fi
      echo "✅ Server build successful - dist/index.js exists"
      
      # Copy client build to server dist directory for runtime access
      echo "📁 Copying client build to server/dist/client..."
      mkdir -p dist/client
      cp -r ../client/dist/* dist/client/
      
      # Verify client files are accessible from server
      if [ -f "dist/client/index.html" ]; then
        echo "✅ Client files copied successfully to server/dist/client"
        echo "📁 Server dist/client contents:"
        ls -la dist/client/
        echo "📁 Total files in server/dist:"
        find dist -type f | wc -l
      else
        echo "❌ Failed to copy client files"
        echo "📁 Current server/dist contents:"
        ls -la dist/
        echo "📁 Current server/dist/client contents (if exists):"
        ls -la dist/client/ 2>/dev/null || echo "dist/client directory not found"
        exit 1
      fi
      
      cd ..
      echo "✅ All builds successful"
    
    startCommand: |
      cd server && npm start
    
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: NPM_CONFIG_REGISTRY
        value: https://registry.npmjs.org/
      - key: NODE_OPTIONS
        value: --max-old-space-size=4096
